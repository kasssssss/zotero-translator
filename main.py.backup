"""
Zotero Translation Assistant
"""

from kivy.app import App
from kivy.uix.boxlayout import BoxLayout
from kivy.uix.label import Label
from kivy.uix.textinput import TextInput
from kivy.uix.button import Button
from kivy.uix.scrollview import ScrollView
from kivy.uix.popup import Popup
from kivy.uix.switch import Switch
from kivy.uix.spinner import Spinner
from kivy.clock import Clock
from kivy.core.clipboard import Clipboard
from kivy.core.window import Window
from kivy.properties import StringProperty, BooleanProperty
from kivy.utils import platform
from kivy.storage.jsonstore import JsonStore
from kivy.metrics import dp
from kivy.graphics import Color, RoundedRectangle

import threading

from translator import TranslatorService


# Android utilities
def vibrate(duration=100):
    """Vibrate device (Android only)"""
    if platform == 'android':
        try:
            from jnius import autoclass
            PythonActivity = autoclass('org.kivy.android.PythonActivity')
            Context = autoclass('android.content.Context')
            activity = PythonActivity.mActivity
            vibrator = activity.getSystemService(Context.VIBRATOR_SERVICE)
            vibrator.vibrate(duration)
        except:
            pass


def show_toast(message):
    """Show toast message (Android only)"""
    if platform == 'android':
        try:
            from jnius import autoclass
            from android.runnable import run_on_ui_thread
            
            @run_on_ui_thread
            def _show_toast(msg):
                PythonActivity = autoclass('org.kivy.android.PythonActivity')
                Toast = autoclass('android.widget.Toast')
                context = PythonActivity.mActivity
                toast = Toast.makeText(context, msg, Toast.LENGTH_SHORT)
                toast.show()
            
            _show_toast(message)
        except:
            pass


class AndroidForegroundService:
    """Android Foreground Service for background clipboard monitoring"""
    
    def __init__(self):
        self.notification_id = 1001
        self.channel_id = "ZoteroTranslator"
        self.is_running = False
    
    def start(self):
        """Start foreground service with notification"""
        if platform != 'android':
            return
        
        try:
            from jnius import autoclass
            from android.runnable import run_on_ui_thread
            
            PythonActivity = autoclass('org.kivy.android.PythonActivity')
            Context = autoclass('android.content.Context')
            NotificationBuilder = autoclass('android.app.Notification$Builder')
            NotificationChannel = autoclass('android.app.NotificationChannel')
            NotificationManager = autoclass('android.app.NotificationManager')
            PendingIntent = autoclass('android.app.PendingIntent')
            Intent = autoclass('android.content.Intent')
            VERSION = autoclass('android.os.Build$VERSION')
            
            activity = PythonActivity.mActivity
            context = activity.getApplicationContext()
            
            # Create notification channel (Android 8.0+)
            if VERSION.SDK_INT >= 26:
                channel = NotificationChannel(
                    self.channel_id,
                    "Zotero Translator",
                    NotificationManager.IMPORTANCE_LOW
                )
                channel.setDescription("Clipboard monitoring service")
                nm = context.getSystemService(Context.NOTIFICATION_SERVICE)
                nm.createNotificationChannel(channel)
            
            # Create notification
            intent = activity.getIntent()
            pending_intent = PendingIntent.getActivity(
                context, 0, intent,
                PendingIntent.FLAG_UPDATE_CURRENT | PendingIntent.FLAG_IMMUTABLE
            )
            
            if VERSION.SDK_INT >= 26:
                builder = NotificationBuilder(context, self.channel_id)
            else:
                builder = NotificationBuilder(context)
            
            builder.setContentTitle("Zotero Translator")
            builder.setContentText("Monitoring clipboard...")
            builder.setSmallIcon(activity.getApplicationInfo().icon)
            builder.setContentIntent(pending_intent)
            builder.setOngoing(True)
            
            notification = builder.build()
            
            # Show notification
            nm = context.getSystemService(Context.NOTIFICATION_SERVICE)
            nm.notify(self.notification_id, notification)
            
            self.is_running = True
            print("Foreground service started")
            
        except Exception as e:
            print(f"Foreground service error: {e}")
    
    def stop(self):
        """Stop foreground service"""
        if platform != 'android':
            return
        
        try:
            from jnius import autoclass
            
            PythonActivity = autoclass('org.kivy.android.PythonActivity')
            Context = autoclass('android.content.Context')
            
            activity = PythonActivity.mActivity
            context = activity.getApplicationContext()
            
            nm = context.getSystemService(Context.NOTIFICATION_SERVICE)
            nm.cancel(self.notification_id)
            
            self.is_running = False
            print("Foreground service stopped")
            
        except Exception as e:
            print(f"Stop service error: {e}")
    
    def update_notification(self, text):
        """Update notification text"""
        if platform != 'android' or not self.is_running:
            return
        
        try:
            from jnius import autoclass
            
            PythonActivity = autoclass('org.kivy.android.PythonActivity')
            Context = autoclass('android.content.Context')
            NotificationBuilder = autoclass('android.app.Notification$Builder')
            PendingIntent = autoclass('android.app.PendingIntent')
            VERSION = autoclass('android.os.Build$VERSION')
            
            activity = PythonActivity.mActivity
            context = activity.getApplicationContext()
            
            intent = activity.getIntent()
            pending_intent = PendingIntent.getActivity(
                context, 0, intent,
                PendingIntent.FLAG_UPDATE_CURRENT | PendingIntent.FLAG_IMMUTABLE
            )
            
            if VERSION.SDK_INT >= 26:
                builder = NotificationBuilder(context, self.channel_id)
            else:
                builder = NotificationBuilder(context)
            
            builder.setContentTitle("Zotero Translator")
            builder.setContentText(text)
            builder.setSmallIcon(activity.getApplicationInfo().icon)
            builder.setContentIntent(pending_intent)
            builder.setOngoing(True)
            
            notification = builder.build()
            
            nm = context.getSystemService(Context.NOTIFICATION_SERVICE)
            nm.notify(self.notification_id, notification)
            
        except Exception as e:
            print(f"Update notification error: {e}")


# Floating Bubble implementation with translation panel
class FloatingBubble:
    """Floating bubble for Android with expandable translation panel"""
    
    def __init__(self):
        self.is_showing = False
        self.is_expanded = False
        self.window_manager = None
        self.bubble_view = None
        self.panel_view = None
        self.bubble_params = None
        self.panel_params = None
        self.last_error = ""
        self.on_click_callback = None
        self.density = 1.0
        # Touch tracking for drag
        self.initial_x = 0
        self.initial_y = 0
        self.initial_touch_x = 0
        self.initial_touch_y = 0
        # Click flag for inter-thread communication
        self.click_pending = False
        self.pending_text = None  # Clipboard text captured on click
        
        # For transparent Activity clipboard access
        self.pending_request_id = None
        self.last_processed_request_id = None
        
        # Fallback flag for main Activity clipboard access
        self.pending_clipboard_read = False
        
        # Start polling for SharedPreferences results
        if platform == 'android':
            Clock.schedule_interval(self._poll_clipboard_result, 0.1)  # Check every 100ms
    
    def _poll_clipboard_result(self, dt):
        """Poll SharedPreferences for clipboard result from ClipboardBridgeActivity"""
        if not self.pending_request_id:
            return
        
        try:
            from jnius import autoclass
            PythonActivity = autoclass('org.kivy.android.PythonActivity')
            Context = autoclass('android.content.Context')
            
            activity = PythonActivity.mActivity
            if not activity:
                return
            
            # Read from SharedPreferences
            prefs = activity.getSharedPreferences("zoterotranslator", Context.MODE_PRIVATE)
            result_request_id = prefs.getString("clip_request_id", "")
            
            # Check if this is our request
            if result_request_id == self.pending_request_id:
                self.update_status("step3")
                clip_text = prefs.getString("clip_text", "")
                
                print(f"[FloatingBubble] Got clipboard result for request {result_request_id}")
                print(f"[FloatingBubble] Text length: {len(clip_text) if clip_text else 0}")
                
                # Clear pending request
                self.pending_request_id = None
                self.last_processed_request_id = result_request_id
                
                # Vibrate to indicate we got the text
                try:
                    vibrator = activity.getSystemService(Context.VIBRATOR_SERVICE)
                    vibrator.vibrate(100)
                except:
                    pass
                
                if clip_text and len(clip_text.strip()) > 0:
                    # Start translation in background
                    print(f"[FloatingBubble] Starting background translation...")
                    self._start_background_translation(clip_text)
                else:
                    show_toast("Clipboard empty")
                    self.update_status("error")
                    
        except Exception as e:
            print(f"[FloatingBubble] Poll error: {e}")
    
    def _start_background_translation(self, text):
        """Start translation in background thread, update bubble when done"""
        import threading
        
        def translate_thread():
            try:
                # Get app instance and translator
                app = App.get_running_app()
                if not app or not hasattr(app, 'main_widget'):
                    print("[FloatingBubble] No app or main_widget")
                    return
                
                translator = app.main_widget.translator
                target_lang = app.main_widget.target_language
                
                print(f"[FloatingBubble] Translating to {target_lang}...")
                
                # Do translation
                result = translator.translate(text, target_lang)
                
                if result:
                    print(f"[FloatingBubble] Translation success: {result[:50]}...")
                    # Update UI on main thread
                    Clock.schedule_once(lambda dt: self._show_translation_result(result), 0)
                else:
                    print("[FloatingBubble] Translation returned empty")
                    Clock.schedule_once(lambda dt: self._show_translation_error("Translation failed"), 0)
                    
            except Exception as e:
                print(f"[FloatingBubble] Translation error: {e}")
                import traceback
                traceback.print_exc()
                Clock.schedule_once(lambda dt: self._show_translation_error(str(e)), 0)
        
        # Start translation thread
        thread = threading.Thread(target=translate_thread)
        thread.daemon = True
        thread.start()
    
    def _show_translation_result(self, result):
        """Show translation result in bubble panel (called on main thread)"""
        try:
            self.show_translation(result)
            self.update_status("idle")
            
            # Vibrate to indicate translation complete
            if platform == 'android':
                try:
                    from jnius import autoclass
                    PythonActivity = autoclass('org.kivy.android.PythonActivity')
                    Context = autoclass('android.content.Context')
                    activity = PythonActivity.mActivity
                    vibrator = activity.getSystemService(Context.VIBRATOR_SERVICE)
                    vibrator.vibrate(200)
                except:
                    pass
        except Exception as e:
            print(f"[FloatingBubble] Show result error: {e}")
    
    def _show_translation_error(self, error):
        """Show translation error (called on main thread)"""
        try:
            self.update_status("error")
            show_toast(f"Error: {error[:50]}")
        except Exception as e:
            print(f"[FloatingBubble] Show error error: {e}")
    
    def show(self, status="monitoring"):
        """Show floating bubble"""
        if platform != 'android':
            self.last_error = "Not Android"
            return False
        
        if self.is_showing:
            return True
        
        try:
            from jnius import autoclass, PythonJavaClass, java_method
            from android.runnable import run_on_ui_thread
            
            self_ref = self  # Reference for inner function
            
            # Create touch listener class for drag & click
            MotionEvent = autoclass('android.view.MotionEvent')
            
            class BubbleTouchListener(PythonJavaClass):
                __javainterfaces__ = ['android/view/View$OnTouchListener']
                __javacontext__ = 'app'
                
                def __init__(self, bubble_ref):
                    super().__init__()
                    self.bubble_ref = bubble_ref
                    self.is_dragging = False
                    self.click_threshold = 10  # pixels
                
                @java_method('(Landroid/view/View;Landroid/view/MotionEvent;)Z')
                def onTouch(self, view, event):
                    action = event.getAction()
                    
                    if action == MotionEvent.ACTION_DOWN:
                        # Record initial positions
                        self.bubble_ref.initial_x = self.bubble_ref.bubble_params.x
                        self.bubble_ref.initial_y = self.bubble_ref.bubble_params.y
                        self.bubble_ref.initial_touch_x = event.getRawX()
                        self.bubble_ref.initial_touch_y = event.getRawY()
                        self.is_dragging = False
                        return True
                    
                    elif action == MotionEvent.ACTION_MOVE:
                        # Calculate movement
                        dx = event.getRawX() - self.bubble_ref.initial_touch_x
                        dy = event.getRawY() - self.bubble_ref.initial_touch_y
                        
                        # Check if this is a drag (moved more than threshold)
                        if abs(dx) > self.click_threshold or abs(dy) > self.click_threshold:
                            if not self.is_dragging:
                                # First time entering drag mode
                                self.is_dragging = True
                                
                                # Hide panel immediately in same thread to avoid race condition
                                if self.bubble_ref.is_expanded and self.bubble_ref.panel_view:
                                    try:
                                        self.bubble_ref.window_manager.removeView(self.bubble_ref.panel_view)
                                        self.bubble_ref.panel_view = None
                                        self.bubble_ref.is_expanded = False
                                        print("[FloatingBubble] Panel hidden on drag start")
                                    except Exception as e:
                                        print(f"[FloatingBubble] Panel hide error: {e}")
                        
                        if self.is_dragging:
                            try:
                                # Update bubble position
                                new_x = int(self.bubble_ref.initial_x + dx)
                                new_y = int(self.bubble_ref.initial_y + dy)
                                
                                # Ensure valid values
                                if new_x < 0:
                                    new_x = 0
                                if new_y < 0:
                                    new_y = 0
                                
                                self.bubble_ref.bubble_params.x = new_x
                                self.bubble_ref.bubble_params.y = new_y
                                self.bubble_ref.window_manager.updateViewLayout(
                                    self.bubble_ref.bubble_view, 
                                    self.bubble_ref.bubble_params
                                )
                            except Exception as e:
                                print(f"[FloatingBubble] Drag error: {e}")
                        return True
                    
                    elif action == MotionEvent.ACTION_UP:
                        if not self.is_dragging:
                            # This is a click - launch transparent ClipboardBridgeActivity
                            print("[FloatingBubble] Click detected!")
                            self.bubble_ref.update_status("step1")
                            
                            try:
                                import time
                                PythonActivity = autoclass('org.kivy.android.PythonActivity')
                                Context = autoclass('android.content.Context')
                                Intent = autoclass('android.content.Intent')
                                activity = PythonActivity.mActivity
                                
                                # First, hide any existing panel to avoid conflicts
                                if self.bubble_ref.is_expanded and self.bubble_ref.panel_view:
                                    try:
                                        self.bubble_ref.window_manager.removeView(self.bubble_ref.panel_view)
                                        self.bubble_ref.panel_view = None
                                        self.bubble_ref.is_expanded = False
                                    except:
                                        self.bubble_ref.panel_view = None
                                        self.bubble_ref.is_expanded = False
                                
                                # Vibrate: Click detected (short)
                                vibrator = activity.getSystemService(Context.VIBRATOR_SERVICE)
                                vibrator.vibrate(50)
                                
                                # Generate unique request ID
                                request_id = str(int(time.time() * 1000))
                                self.bubble_ref.pending_request_id = request_id
                                
                                # Try to launch transparent ClipboardBridgeActivity
                                launched = False
                                try:
                                    self.bubble_ref.update_status("step2")
                                    # Create Intent explicitly with package and class name
                                    intent = Intent()
                                    intent.setClassName(activity.getPackageName(), "org.zotero.zoterotranslator.ClipboardBridgeActivity")
                                    intent.putExtra("request_id", request_id)
                                    intent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK)
                                    intent.addFlags(Intent.FLAG_ACTIVITY_NO_ANIMATION)
                                    
                                    activity.startActivity(intent)
                                    try:
                                        activity.overridePendingTransition(0, 0)
                                    except:
                                        pass
                                    launched = True
                                    print(f"[FloatingBubble] Launched ClipboardBridgeActivity: {request_id}")
                                    vibrator.vibrate(100)
                                except Exception as bridge_err:
                                    print(f"[FloatingBubble] ClipboardBridgeActivity failed: {bridge_err}")
                                    self.bubble_ref.update_status("fallback")
                                    
                                    # Fallback: bring main Activity to front
                                    try:
                                        intent = activity.getIntent()
                                        intent.addFlags(Intent.FLAG_ACTIVITY_REORDER_TO_FRONT)
                                        intent.addFlags(Intent.FLAG_ACTIVITY_SINGLE_TOP)
                                        intent.addFlags(Intent.FLAG_ACTIVITY_NO_ANIMATION)
                                        activity.startActivity(intent)
                                        try:
                                            activity.overridePendingTransition(0, 0)
                                        except:
                                            pass
                                        
                                        # Set flag for main Activity to read clipboard on resume
                                        self.bubble_ref.pending_clipboard_read = True
                                        launched = True
                                        print("[FloatingBubble] Fallback to main Activity")
                                        vibrator.vibrate(150)
                                    except Exception as main_err:
                                        print(f"[FloatingBubble] Main Activity fallback failed: {main_err}")
                                
                                if not launched:
                                    self.bubble_ref.update_status("error")
                                    vibrator.vibrate(500)
                                    
                            except Exception as e:
                                print(f"[FloatingBubble] Click handler error: {e}")
                                self.bubble_ref.update_status("error")
                        return True
                    
                    return False
            
            @run_on_ui_thread
            def _show():
                try:
                    PythonActivity = autoclass('org.kivy.android.PythonActivity')
                    Context = autoclass('android.content.Context')
                    LayoutParams = autoclass('android.view.WindowManager$LayoutParams')
                    PixelFormat = autoclass('android.graphics.PixelFormat')
                    Gravity = autoclass('android.view.Gravity')
                    TextView = autoclass('android.widget.TextView')
                    AndroidColor = autoclass('android.graphics.Color')
                    GradientDrawable = autoclass('android.graphics.drawable.GradientDrawable')
                    VERSION = autoclass('android.os.Build$VERSION')
                    Settings = autoclass('android.provider.Settings')
                    TypedValue = autoclass('android.util.TypedValue')
                    
                    activity = PythonActivity.mActivity
                    
                    # Check permission
                    if VERSION.SDK_INT >= 23:
                        if not Settings.canDrawOverlays(activity):
                            self_ref.last_error = "No overlay permission"
                            return
                    
                    self_ref.window_manager = activity.getSystemService(Context.WINDOW_SERVICE)
                    
                    # Get display metrics for dp conversion
                    metrics = activity.getResources().getDisplayMetrics()
                    self_ref.density = metrics.density
                    
                    # === Create Bubble (small circle) ===
                    JavaString = autoclass('java.lang.String')
                    
                    self_ref.bubble_view = TextView(activity)
                    self_ref.bubble_view.setText(JavaString("T"))
                    self_ref.bubble_view.setTextSize(TypedValue.COMPLEX_UNIT_SP, 20)
                    self_ref.bubble_view.setGravity(Gravity.CENTER)
                    self_ref.bubble_view.setTextColor(AndroidColor.WHITE)
                    
                    bubble_bg = GradientDrawable()
                    bubble_bg.setShape(GradientDrawable.OVAL)
                    bubble_bg.setColor(AndroidColor.parseColor("#4CAF50"))
                    self_ref.bubble_view.setBackground(bubble_bg)
                    
                    # Set layout params for bubble
                    if VERSION.SDK_INT >= 26:
                        layout_type = LayoutParams.TYPE_APPLICATION_OVERLAY
                    else:
                        layout_type = LayoutParams.TYPE_PHONE
                    
                    bubble_size = int(56 * self_ref.density)  # 56dp
                    self_ref.bubble_params = LayoutParams(
                        bubble_size, bubble_size,
                        layout_type,
                        LayoutParams.FLAG_NOT_FOCUSABLE,
                        PixelFormat.TRANSLUCENT
                    )
                    self_ref.bubble_params.gravity = Gravity.TOP | Gravity.LEFT
                    self_ref.bubble_params.x = int(16 * self_ref.density)
                    self_ref.bubble_params.y = int(200 * self_ref.density)
                    
                    # Add touch listener for drag & click
                    touch_listener = BubbleTouchListener(self_ref)
                    self_ref.bubble_view.setOnTouchListener(touch_listener)
                    
                    # Add bubble to window
                    self_ref.window_manager.addView(self_ref.bubble_view, self_ref.bubble_params)
                    self_ref.is_showing = True
                    self_ref.last_error = ""
                    print("[FloatingBubble] Bubble shown with touch support!")
                    
                except Exception as e:
                    self_ref.last_error = str(e)
                    print(f"[FloatingBubble] Show error: {e}")
                    import traceback
                    traceback.print_exc()
            
            _show()
            return True
            
        except Exception as e:
            self.last_error = str(e)
            print(f"[FloatingBubble] Import error: {e}")
            return False
    
    def hide(self):
        """Hide floating bubble and panel"""
        if platform != 'android':
            return
        
        try:
            from android.runnable import run_on_ui_thread
            
            self_ref = self
            
            @run_on_ui_thread
            def _hide():
                try:
                    if self_ref.bubble_view and self_ref.window_manager:
                        self_ref.window_manager.removeView(self_ref.bubble_view)
                        self_ref.bubble_view = None
                    if self_ref.panel_view and self_ref.window_manager:
                        self_ref.window_manager.removeView(self_ref.panel_view)
                        self_ref.panel_view = None
                    self_ref.is_showing = False
                    self_ref.is_expanded = False
                    print("[FloatingBubble] Hidden")
                except Exception as e:
                    print(f"[FloatingBubble] Hide error: {e}")
            
            _hide()
            
        except Exception as e:
            print(f"[FloatingBubble] Hide import error: {e}")
    
    def show_translation(self, text):
        """Show translation in expanded panel"""
        print(f"[FloatingBubble] show_translation called, text length: {len(text) if text else 0}")
        print(f"[FloatingBubble] is_showing: {self.is_showing}, platform: {platform}")
        
        if platform != 'android':
            print("[FloatingBubble] Not Android, skipping")
            return
        
        if not self.is_showing:
            print("[FloatingBubble] WARNING: Bubble not showing! Attempting to show via toast...")
            show_toast(f"Result: {text[:50]}...")
            return
        
        try:
            from jnius import autoclass
            from android.runnable import run_on_ui_thread
            
            self_ref = self
            translation_text = text  # Capture text in closure
            
            @run_on_ui_thread
            def _show_panel():
                try:
                    print("[FloatingBubble] _show_panel executing on UI thread...")
                    PythonActivity = autoclass('org.kivy.android.PythonActivity')
                    Context = autoclass('android.content.Context')
                    LayoutParams = autoclass('android.view.WindowManager$LayoutParams')
                    PixelFormat = autoclass('android.graphics.PixelFormat')
                    Gravity = autoclass('android.view.Gravity')
                    TextView = autoclass('android.widget.TextView')
                    AndroidColor = autoclass('android.graphics.Color')
                    GradientDrawable = autoclass('android.graphics.drawable.GradientDrawable')
                    VERSION = autoclass('android.os.Build$VERSION')
                    ScrollView = autoclass('android.widget.ScrollView')
                    TypedValue = autoclass('android.util.TypedValue')
                    
                    activity = PythonActivity.mActivity
                    if not activity:
                        print("[FloatingBubble] No activity!")
                        return
                        
                    metrics = activity.getResources().getDisplayMetrics()
                    density = metrics.density
                    
                    # Remove old panel if exists
                    if self_ref.panel_view and self_ref.window_manager:
                        try:
                            self_ref.window_manager.removeView(self_ref.panel_view)
                            print("[FloatingBubble] Old panel removed")
                        except Exception as re:
                            print(f"[FloatingBubble] Remove old panel error: {re}")
                        finally:
                            self_ref.panel_view = None
                            self_ref.is_expanded = False
                    
                    # Create scroll view container
                    scroll = ScrollView(activity)
                    scroll.setFillViewport(True)
                    
                    # Create text view for translation
                    JavaString = autoclass('java.lang.String')
                    text_view = TextView(activity)
                    text_view.setText(JavaString(translation_text))
                    print(f"[FloatingBubble] TextView created with text")
                    text_view.setTextSize(TypedValue.COMPLEX_UNIT_SP, 14)
                    text_view.setTextColor(AndroidColor.parseColor("#FFFFFF"))
                    text_view.setPadding(int(12*density), int(12*density), int(12*density), int(12*density))
                    
                    scroll.addView(text_view)
                    
                    # Background
                    panel_bg = GradientDrawable()
                    panel_bg.setCornerRadius(12 * density)
                    panel_bg.setColor(AndroidColor.parseColor("#DD333333"))
                    scroll.setBackground(panel_bg)
                    
                    self_ref.panel_view = scroll
                    
                    # Layout params for panel
                    if VERSION.SDK_INT >= 26:
                        layout_type = LayoutParams.TYPE_APPLICATION_OVERLAY
                    else:
                        layout_type = LayoutParams.TYPE_PHONE
                    
                    panel_width = int(280 * density)
                    panel_height = int(200 * density)
                    
                    self_ref.panel_params = LayoutParams(
                        panel_width, panel_height,
                        layout_type,
                        LayoutParams.FLAG_NOT_FOCUSABLE,
                        PixelFormat.TRANSLUCENT
                    )
                    self_ref.panel_params.gravity = Gravity.TOP | Gravity.LEFT
                    
                    # Position panel relative to bubble
                    bubble_size = int(56 * density)
                    bubble_x = self_ref.bubble_params.x if self_ref.bubble_params else int(16 * density)
                    bubble_y = self_ref.bubble_params.y if self_ref.bubble_params else int(200 * density)
                    
                    # Place panel to the right of bubble, or below if not enough space
                    screen_width = metrics.widthPixels
                    if bubble_x + bubble_size + panel_width + 10 < screen_width:
                        # Place to the right
                        self_ref.panel_params.x = bubble_x + bubble_size + int(8 * density)
                        self_ref.panel_params.y = bubble_y
                    else:
                        # Place to the left
                        self_ref.panel_params.x = max(int(8 * density), bubble_x - panel_width - int(8 * density))
                        self_ref.panel_params.y = bubble_y
                    
                    self_ref.window_manager.addView(self_ref.panel_view, self_ref.panel_params)
                    self_ref.is_expanded = True
                    print("[FloatingBubble] Panel shown!")
                    
                except Exception as e:
                    print(f"[FloatingBubble] Show panel error: {e}")
                    import traceback
                    traceback.print_exc()
            
            _show_panel()
            
        except Exception as e:
            print(f"[FloatingBubble] Panel import error: {e}")
    
    def hide_panel(self):
        """Hide translation panel"""
        if platform != 'android' or not self.panel_view:
            return
        
        try:
            from android.runnable import run_on_ui_thread
            
            self_ref = self
            
            @run_on_ui_thread
            def _hide_panel():
                try:
                    if self_ref.panel_view and self_ref.window_manager:
                        self_ref.window_manager.removeView(self_ref.panel_view)
                        self_ref.panel_view = None
                        self_ref.is_expanded = False
                except Exception as e:
                    print(f"[FloatingBubble] Hide panel error: {e}")
            
            _hide_panel()
            
        except Exception as e:
            print(f"[FloatingBubble] Hide panel import error: {e}")
    
    def update_status(self, status):
        """Update bubble status with numbers for debugging"""
        if platform != 'android' or not self.bubble_view:
            return
        
        try:
            from jnius import autoclass
            from android.runnable import run_on_ui_thread
            
            AndroidColor = autoclass('android.graphics.Color')
            JavaString = autoclass('java.lang.String')
            self_ref = self
            status_text = status
            
            @run_on_ui_thread
            def _update():
                try:
                    bg = self_ref.bubble_view.getBackground()
                    
                    # Status mappings
                    if status_text == "step1":
                        self_ref.bubble_view.setText(JavaString("1"))
                        if bg: bg.setColor(AndroidColor.parseColor("#FF9800")) # Orange
                    elif status_text == "step2":
                        self_ref.bubble_view.setText(JavaString("2"))
                        if bg: bg.setColor(AndroidColor.parseColor("#FFC107")) # Amber
                    elif status_text == "step3":
                        self_ref.bubble_view.setText(JavaString("3"))
                        if bg: bg.setColor(AndroidColor.parseColor("#4CAF50")) # Green
                    elif status_text == "step4":
                        self_ref.bubble_view.setText(JavaString("4"))
                        if bg: bg.setColor(AndroidColor.parseColor("#9C27B0")) # Purple (API)
                    elif status_text == "step5":
                        self_ref.bubble_view.setText(JavaString("5"))
                        if bg: bg.setColor(AndroidColor.parseColor("#00BCD4")) # Cyan (Rendering)
                    elif status_text == "translating":
                        self_ref.bubble_view.setText(JavaString("..."))
                        if bg: bg.setColor(AndroidColor.parseColor("#9C27B0"))
                    elif status_text == "done":
                        self_ref.bubble_view.setText(JavaString("OK"))
                        if bg: bg.setColor(AndroidColor.parseColor("#4CAF50"))
                    elif status_text == "fallback":
                        self_ref.bubble_view.setText(JavaString("F"))
                        if bg: bg.setColor(AndroidColor.parseColor("#E91E63")) # Pink
                    elif status_text == "error":
                        self_ref.bubble_view.setText(JavaString("E"))
                        if bg: bg.setColor(AndroidColor.parseColor("#F44336")) # Red
                    else:
                        self_ref.bubble_view.setText(JavaString("T"))
                        if bg: bg.setColor(AndroidColor.parseColor("#2196F3")) # Blue
                except Exception as e:
                    print(f"[FloatingBubble] Update error: {e}")
            
            _update()
            
        except Exception as e:
            print(f"[FloatingBubble] Update import error: {e}")


class SettingsPopup(Popup):
    """Settings popup"""
    
    def __init__(self, app, **kwargs):
        super().__init__(**kwargs)
        self.app = app
        self.title = "Settings"
        self.size_hint = (0.9, 0.85)
        
        layout = BoxLayout(orientation='vertical', padding=dp(15), spacing=dp(12))
        
        # API Key
        api_section = BoxLayout(orientation='vertical', size_hint_y=None, height=dp(80))
        api_section.add_widget(Label(text="API Key:", size_hint_y=None, height=dp(25)))
        self.api_key_input = TextInput(
            text=self.app.config_store.get('settings')['api_key'] if self.app.config_store.exists('settings') else '',
            multiline=False,
            password=True,
            size_hint_y=None,
            height=dp(45),
            hint_text="Enter SiliconFlow API Key"
        )
        api_section.add_widget(self.api_key_input)
        layout.add_widget(api_section)
        
        # API URL
        url_section = BoxLayout(orientation='vertical', size_hint_y=None, height=dp(80))
        url_section.add_widget(Label(text="API URL:", size_hint_y=None, height=dp(25)))
        self.api_url_input = TextInput(
            text=self.app.config_store.get('settings')['api_url'] if self.app.config_store.exists('settings') else 'https://api.siliconflow.cn',
            multiline=False,
            size_hint_y=None,
            height=dp(45)
        )
        url_section.add_widget(self.api_url_input)
        layout.add_widget(url_section)
        
        # Model
        model_section = BoxLayout(orientation='vertical', size_hint_y=None, height=dp(80))
        model_section.add_widget(Label(text="Model:", size_hint_y=None, height=dp(25)))
        models = [
            'Qwen/Qwen2.5-7B-Instruct',
            'Qwen/Qwen2.5-14B-Instruct',
            'Qwen/Qwen2.5-32B-Instruct',
            'deepseek-ai/DeepSeek-V2.5',
        ]
        current_model = self.app.config_store.get('settings')['model'] if self.app.config_store.exists('settings') else models[0]
        self.model_spinner = Spinner(
            text=current_model,
            values=models,
            size_hint_y=None,
            height=dp(45)
        )
        model_section.add_widget(self.model_spinner)
        layout.add_widget(model_section)
        
        # Auto translate
        auto_section = BoxLayout(orientation='horizontal', size_hint_y=None, height=dp(50))
        auto_section.add_widget(Label(text="Auto Monitor:", size_hint_x=0.7))
        self.auto_switch = Switch(
            active=self.app.config_store.get('settings').get('auto_translate', True) if self.app.config_store.exists('settings') else True,
            size_hint_x=0.3
        )
        auto_section.add_widget(self.auto_switch)
        layout.add_widget(auto_section)
        
        # Target language
        lang_section = BoxLayout(orientation='vertical', size_hint_y=None, height=dp(80))
        lang_section.add_widget(Label(text="Target:", size_hint_y=None, height=dp(25)))
        languages = ['Chinese', 'English', 'Japanese']
        current_lang = self.app.config_store.get('settings').get('target_lang', 'Chinese') if self.app.config_store.exists('settings') else 'Chinese'
        self.lang_spinner = Spinner(
            text=current_lang,
            values=languages,
            size_hint_y=None,
            height=dp(45)
        )
        lang_section.add_widget(self.lang_spinner)
        layout.add_widget(lang_section)
        
        # Floating bubble switch
        bubble_section = BoxLayout(orientation='horizontal', size_hint_y=None, height=dp(50))
        bubble_section.add_widget(Label(text="Floating Bubble:", size_hint_x=0.7))
        self.bubble_switch = Switch(
            active=self.app.config_store.get('settings').get('enable_bubble', False) if self.app.config_store.exists('settings') else False,
            size_hint_x=0.3
        )
        bubble_section.add_widget(self.bubble_switch)
        layout.add_widget(bubble_section)
        
        # Request overlay permission button
        perm_btn = Button(
            text="Request Overlay Permission",
            size_hint_y=None,
            height=dp(45),
            background_color=(0.5, 0.5, 0.6, 1)
        )
        perm_btn.bind(on_press=self.request_overlay_permission)
        layout.add_widget(perm_btn)
        
        layout.add_widget(BoxLayout(size_hint_y=0.05))
        
        # Save button
        save_btn = Button(
            text="Save",
            size_hint_y=None,
            height=dp(50),
            background_color=(0.2, 0.7, 0.3, 1)
        )
        save_btn.bind(on_press=self.save_settings)
        layout.add_widget(save_btn)
        
        self.content = layout
    
    def request_overlay_permission(self, instance):
        """Request overlay permission on Android"""
        if platform != 'android':
            show_toast("Only available on Android")
            return
        
        try:
            from jnius import autoclass
            
            VERSION = autoclass('android.os.Build$VERSION')
            Settings = autoclass('android.provider.Settings')
            Intent = autoclass('android.content.Intent')
            Uri = autoclass('android.net.Uri')
            PythonActivity = autoclass('org.kivy.android.PythonActivity')
            
            activity = PythonActivity.mActivity
            pkg_name = activity.getPackageName()
            
            print(f"[Permission] Package: {pkg_name}")
            print(f"[Permission] SDK: {VERSION.SDK_INT}")
            
            if VERSION.SDK_INT >= 23:
                has_perm = Settings.canDrawOverlays(activity)
                print(f"[Permission] Has overlay: {has_perm}")
                
                if not has_perm:
                    # Create intent to open overlay settings
                    uri = Uri.parse("package:" + pkg_name)
                    intent = Intent(Settings.ACTION_MANAGE_OVERLAY_PERMISSION, uri)
                    intent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK)
                    activity.startActivity(intent)
                    show_toast("Opening permission settings...")
                else:
                    show_toast("Permission already granted!")
                    # Try to show bubble immediately
                    self.app.floating_bubble.show("ready")
            else:
                show_toast("No permission needed")
                self.app.floating_bubble.show("ready")
                
        except Exception as e:
            import traceback
            traceback.print_exc()
            show_toast(f"Error: {str(e)[:50]}")
    
    def save_settings(self, instance):
        settings = {
            'api_key': self.api_key_input.text,
            'api_url': self.api_url_input.text,
            'model': self.model_spinner.text,
            'auto_translate': self.auto_switch.active,
            'target_lang': self.lang_spinner.text,
            'enable_bubble': self.bubble_switch.active
        }
        self.app.config_store.put('settings', **settings)
        self.app.update_translator_config()
        
        # Apply bubble setting immediately
        if self.bubble_switch.active:
            self.app.floating_bubble.show("ready")
            show_toast("Floating bubble enabled")
        else:
            self.app.floating_bubble.hide()
            show_toast("Floating bubble disabled")
        
        self.dismiss()


class ScrollableLabel(ScrollView):
    """Scrollable text display widget"""
    
    def __init__(self, **kwargs):
        super().__init__(**kwargs)
        self.text_widget = TextInput(
            multiline=True,
            readonly=True,
            background_color=(0.15, 0.18, 0.15, 1),
            foreground_color=(0.9, 1.0, 0.9, 1),
            hint_text="Translation appears here...",
            size_hint_y=None
        )
        self.text_widget.bind(minimum_height=self.text_widget.setter('height'))
        self.add_widget(self.text_widget)
    
    @property
    def text(self):
        return self.text_widget.text
    
    @text.setter
    def text(self, value):
        self.text_widget.text = value
        # Scroll to top when new text is set
        self.scroll_y = 1


class TranslatorWidget(BoxLayout):
    """Main translator interface"""
    
    is_monitoring = BooleanProperty(False)
    
    def __init__(self, app, **kwargs):
        super().__init__(**kwargs)
        self.app = app
        self.orientation = 'vertical'
        self.padding = dp(10)
        self.spacing = dp(8)
        self.last_clipboard = ""
        self.is_translating = False  # Translation lock
        
        # Start bubble click checker (legacy fallback)
        Clock.schedule_interval(self._check_bubble_click, 0.3)
        
        with self.canvas.before:
            Color(0.12, 0.12, 0.15, 1)
            self.bg_rect = RoundedRectangle(pos=self.pos, size=self.size, radius=[dp(15)])
        self.bind(pos=self._update_bg, size=self._update_bg)
        
        self._build_ui()
    
    def _update_bg(self, *args):
        self.bg_rect.pos = self.pos
        self.bg_rect.size = self.size
    
    def _build_ui(self):
        # Title bar
        title_bar = BoxLayout(size_hint_y=None, height=dp(50), spacing=dp(5))
        
        title_bar.add_widget(Label(
            text="Zotero Translator",
            font_size=dp(18),
            size_hint_x=0.4,
            color=(0.9, 0.85, 0.7, 1)
        ))
        
        # Test bubble button
        bubble_btn = Button(text="Bubble", size_hint_x=0.2, background_color=(0.6, 0.4, 0.2, 1))
        bubble_btn.bind(on_press=self.test_bubble)
        title_bar.add_widget(bubble_btn)
        
        settings_btn = Button(text="Set", size_hint_x=0.2, background_color=(0.3, 0.3, 0.35, 1))
        settings_btn.bind(on_press=self.open_settings)
        title_bar.add_widget(settings_btn)
        
        self.monitor_btn = Button(text="Start", size_hint_x=0.2, background_color=(0.2, 0.6, 0.3, 1))
        self.monitor_btn.bind(on_press=self.toggle_monitoring)
        title_bar.add_widget(self.monitor_btn)
        
        self.add_widget(title_bar)
        
        # Status
        self.status_label = Label(
            text="Stopped",
            size_hint_y=None,
            height=dp(30),
            font_size=dp(14),
            color=(0.7, 0.7, 0.7, 1)
        )
        self.add_widget(self.status_label)
        
        # Source area
        source_section = BoxLayout(orientation='vertical', size_hint_y=0.30)
        source_header = BoxLayout(size_hint_y=None, height=dp(30))
        source_header.add_widget(Label(text="Source:", size_hint_x=0.7, color=(0.8, 0.8, 0.9, 1)))
        paste_btn = Button(text="Paste", size_hint_x=0.3, background_color=(0.4, 0.4, 0.5, 1))
        paste_btn.bind(on_press=self.paste_text)
        source_header.add_widget(paste_btn)
        source_section.add_widget(source_header)
        
        self.source_input = TextInput(
            multiline=True,
            background_color=(0.18, 0.18, 0.22, 1),
            foreground_color=(0.95, 0.95, 0.95, 1),
            hint_text="Paste text here..."
        )
        source_section.add_widget(self.source_input)
        self.add_widget(source_section)
        
        # Translate button
        translate_btn = Button(
            text="Translate",
            size_hint_y=None,
            height=dp(50),
            background_color=(0.25, 0.5, 0.8, 1),
            font_size=dp(18)
        )
        translate_btn.bind(on_press=self.manual_translate)
        self.add_widget(translate_btn)
        
        # Translation area - scrollable
        trans_section = BoxLayout(orientation='vertical', size_hint_y=0.50)
        trans_header = BoxLayout(size_hint_y=None, height=dp(30))
        trans_header.add_widget(Label(text="Translation:", size_hint_x=0.5, color=(0.8, 0.9, 0.8, 1)))
        
        scroll_top_btn = Button(text="Top", size_hint_x=0.25, background_color=(0.3, 0.4, 0.5, 1))
        scroll_top_btn.bind(on_press=self.scroll_to_top)
        trans_header.add_widget(scroll_top_btn)
        
        copy_btn = Button(text="Copy", size_hint_x=0.25, background_color=(0.4, 0.5, 0.4, 1))
        copy_btn.bind(on_press=self.copy_translation)
        trans_header.add_widget(copy_btn)
        trans_section.add_widget(trans_header)
        
        # Use ScrollableLabel for translation output
        self.trans_output = ScrollableLabel()
        trans_section.add_widget(self.trans_output)
        self.add_widget(trans_section)
    
    def scroll_to_top(self, instance):
        """Scroll translation to top"""
        self.trans_output.scroll_y = 1
    
    def _check_bubble_click(self, dt):
        """Check if bubble was clicked (legacy fallback, main logic now in on_resume)"""
        # Handle legacy click (fallback for direct clipboard access)
        if self.app.floating_bubble.click_pending:
            self.app.floating_bubble.click_pending = False
            pending_text = self.app.floating_bubble.pending_text
            self.app.floating_bubble.pending_text = None
            
            print("[BubbleClick] Processing legacy click...")
            
            if pending_text:
                # Use the text captured on click
                show_toast("Translating...")
                self._do_bubble_translate_with_text(pending_text)
            else:
                # Try to read clipboard in Kivy (may fail in background)
                show_toast("Reading clipboard...")
                self._do_bubble_translate()
    
    def _do_bubble_translate_with_text(self, text):
        """Translate with provided text"""
        print(f"[BubbleTranslate] With text: {text[:50]}...")
        
        if self.is_translating:
            show_toast("Already translating...")
            return
        
        if text and len(text.strip()) > 0:
            # Hide previous panel
            if self.app.floating_bubble.is_expanded:
                self.app.floating_bubble.hide_panel()
            
            # Store source text
            self.source_input.text = text
            self.last_clipboard = text
            
            # Translate (do_translate will update status to step4)
            self.do_translate(text)
        else:
            show_toast("Text is empty")
            if platform == 'android':
                self.app.floating_bubble.update_status("error")
    
    def _do_bubble_translate(self):
        """Try to read clipboard and translate"""
        print("[BubbleTranslate] Trying to read clipboard...")
        
        if self.is_translating:
            show_toast("Already translating...")
            return
        
        current = None
        
        # Try Kivy clipboard
        try:
            current = Clipboard.paste()
            if current:
                print(f"[BubbleTranslate] Got: {current[:50]}...")
        except Exception as e:
            print(f"[BubbleTranslate] Clipboard error: {e}")
        
        if current and len(current.strip()) > 0:
            self._do_bubble_translate_with_text(current)
        else:
            # Cannot read clipboard - show helpful message
            show_toast("Cannot read clipboard. Use split-screen mode.")
            self.app.floating_bubble.update_status("error")
    
    def test_bubble(self, instance):
        """Show bubble and minimize app to background"""
        if platform == 'android':
            try:
                from jnius import autoclass
                VERSION = autoclass('android.os.Build$VERSION')
                Settings = autoclass('android.provider.Settings')
                PythonActivity = autoclass('org.kivy.android.PythonActivity')
                Intent = autoclass('android.content.Intent')
                activity = PythonActivity.mActivity
                
                sdk_int = VERSION.SDK_INT
                
                # Check permission first (Android 6.0+)
                if sdk_int >= 23:
                    has_perm = Settings.canDrawOverlays(activity)
                    
                    if not has_perm:
                        self.status_label.text = "Need overlay permission!"
                        show_toast("Please grant overlay permission first")
                        return
                
                # Show bubble
                if not self.app.floating_bubble.is_showing:
                    result = self.app.floating_bubble.show("monitoring")
                    
                    # Check for errors
                    if self.app.floating_bubble.last_error:
                        self.status_label.text = f"Error: {self.app.floating_bubble.last_error}"
                        show_toast(f"Error: {self.app.floating_bubble.last_error[:30]}")
                        return
                
                # Minimize app to background (go to home screen)
                show_toast("Bubble mode - tap bubble to translate!")
                
                # Use Intent to go to home
                intent = Intent(Intent.ACTION_MAIN)
                intent.addCategory(Intent.CATEGORY_HOME)
                intent.setFlags(Intent.FLAG_ACTIVITY_NEW_TASK)
                activity.startActivity(intent)
                    
            except Exception as e:
                self.status_label.text = f"Error: {e}"
                show_toast(f"Error: {str(e)[:40]}")
                import traceback
                traceback.print_exc()
        else:
            self.status_label.text = "Bubble test (PC - no bubble)"
            show_toast("Only works on Android")
    
    def open_settings(self, instance):
        popup = SettingsPopup(self.app)
        popup.open()
    
    def toggle_monitoring(self, instance):
        self.is_monitoring = not self.is_monitoring
        if self.is_monitoring:
            self.monitor_btn.text = "Stop"
            self.monitor_btn.background_color = (0.8, 0.4, 0.2, 1)
            self.status_label.text = "Monitoring clipboard..."
            self.status_label.color = (0.3, 0.9, 0.3, 1)
            self.clipboard_event = Clock.schedule_interval(self.check_clipboard, 0.8)
            
            # Start foreground service for background monitoring
            self.app.foreground_service.start()
            
            # Show floating bubble if enabled
            if self.app.is_bubble_enabled():
                self.app.floating_bubble.show("monitoring")
            
            vibrate(50)
            show_toast("Monitoring started")
        else:
            self.monitor_btn.text = "Start"
            self.monitor_btn.background_color = (0.2, 0.6, 0.3, 1)
            self.status_label.text = "Stopped"
            self.status_label.color = (0.7, 0.7, 0.7, 1)
            if hasattr(self, 'clipboard_event'):
                self.clipboard_event.cancel()
            
            # Stop foreground service
            self.app.foreground_service.stop()
            
            # Hide floating bubble
            self.app.floating_bubble.hide()
            
            vibrate(50)
            show_toast("Monitoring stopped")
    
    def check_clipboard(self, dt):
        # Skip if already translating
        if self.is_translating:
            return
        
        try:
            current = Clipboard.paste()
            if current and current != self.last_clipboard and len(current.strip()) > 0:
                # Check if content is different enough (not just whitespace changes)
                if current.strip() == self.last_clipboard.strip():
                    return
                
                self.last_clipboard = current
                self.source_input.text = current
                
                # Notify user that new text was detected
                self.status_label.text = "New text detected!"
                vibrate(30)
                show_toast("Text detected, translating...")
                
                # Update notification and floating bubble
                self.app.foreground_service.update_notification("Translating...")
                # Hide previous panel if showing
                if self.app.floating_bubble.is_expanded:
                    self.app.floating_bubble.hide_panel()
                self.app.floating_bubble.update_status("translating")
                
                if self.app.config_store.exists('settings'):
                    if self.app.config_store.get('settings').get('auto_translate', True):
                        self.do_translate(current)
        except:
            pass
    
    def paste_text(self, instance):
        try:
            text = Clipboard.paste()
            if text:
                self.source_input.text = text
                self.status_label.text = "Text pasted"
        except:
            pass
    
    def manual_translate(self, instance):
        text = self.source_input.text.strip()
        if text:
            self.do_translate(text)
    
    def do_translate(self, text):
        # Set translation lock
        self.is_translating = True
        
        # Update bubble status to API phase
        if platform == 'android':
            self.app.floating_bubble.update_status("step4")
            
        self.trans_output.text = "Translating..."
        self.status_label.text = "Translating, please wait..."
        self.status_label.color = (1.0, 0.8, 0.2, 1)
        
        def translate_thread():
            try:
                print("[TranslateThread] Starting translation...")
                # Use a separate status for API request if needed
                result = self.app.translator.translate(text)
                print(f"[TranslateThread] Got result: {result[:50]}...")
                
                # Success! Move to rendering phase
                if platform == 'android':
                    Clock.schedule_once(lambda dt: self.app.floating_bubble.update_status("step5"), 0)
                
                Clock.schedule_once(lambda dt: self.update_translation(result), 0)
            except Exception as e:
                print(f"[TranslateThread] Exception caught: {e}")
                import traceback
                traceback.print_exc()
                if platform == 'android':
                    Clock.schedule_once(lambda dt: self.app.floating_bubble.update_status("error"), 0)
                Clock.schedule_once(lambda dt: self.update_translation(f"Error: {e}"), 0)
        
        thread = threading.Thread(target=translate_thread)
        thread.daemon = True
        thread.start()
        print("[do_translate] Thread started")
    
    def update_translation(self, result):
        # Clear translation lock
        self.is_translating = False
        
        print(f"[UpdateTranslation] Result: {result[:100]}...")
        self.trans_output.text = result
        
        # Check if result is an error message
        is_error = result.startswith("Error:") or result.startswith("Translation failed:")
        
        # Notify user that translation is complete
        vibrate(100)
        
        # Update notification
        self.app.foreground_service.update_notification("Translation done!")
        
        # If bubble is showing, display translation in panel
        if self.app.floating_bubble.is_showing:
            if is_error:
                self.app.floating_bubble.update_status("error")
                show_toast(f"Error: {result[:50]}")
            else:
                self.app.floating_bubble.update_status("done")
                try:
                    print("[UpdateTranslation] Calling show_translation...")
                    self.app.floating_bubble.show_translation(result)
                    show_toast("Translation ready!")
                    print("[UpdateTranslation] show_translation succeeded")
                except Exception as e:
                    print(f"[UpdateTranslation] show_translation error: {e}")
                    import traceback
                    traceback.print_exc()
                    self.app.floating_bubble.update_status("error")
                    # Fallback: display result via long toast
                    show_toast(f"Result: {result[:100]}")
                    print(f"[UpdateTranslation] Fallback toast shown")
        else:
            print("[UpdateTranslation] Bubble not showing, using toast")
            show_toast(f"Done: {result[:50]}")
        
        if self.is_monitoring:
            self.status_label.text = "Done! Monitoring..."
            self.status_label.color = (0.3, 0.9, 0.3, 1)
        else:
            self.status_label.text = "Translation complete"
            self.status_label.color = (0.3, 0.9, 0.3, 1)
    
    def copy_translation(self, instance):
        try:
            text = self.trans_output.text
            if text:
                Clipboard.copy(text)
                self.status_label.text = "Copied to clipboard!"
                vibrate(30)
                show_toast("Copied!")
        except:
            pass


class ZoteroTranslatorApp(App):
    """Main application"""
    
    def build(self):
        self.title = "Zotero Translator"
        
        # Setup Chinese font for Android
        self._setup_font()
        
        self.config_store = JsonStore('translator_config.json')
        self.translator = TranslatorService()
        self.update_translator_config()
        self.floating_bubble = FloatingBubble()
        self.foreground_service = AndroidForegroundService()
        
        if platform not in ('android', 'ios'):
            Window.size = (400, 700)
        
        self.main_widget = TranslatorWidget(self)
        return self.main_widget
    
    def _setup_font(self):
        """Setup Chinese font"""
        try:
            from kivy.core.text import LabelBase
            import os
            
            # Android system fonts
            font_paths = [
                '/system/fonts/NotoSansCJK-Regular.ttc',
                '/system/fonts/NotoSansSC-Regular.otf',
                '/system/fonts/DroidSansFallback.ttf',
            ]
            
            for font_path in font_paths:
                try:
                    if os.path.exists(font_path):
                        LabelBase.register(name='Roboto', fn_regular=font_path)
                        print(f"Font registered: {font_path}")
                        return
                except:
                    continue
        except Exception as e:
            print(f"Font setup skipped: {e}")
    
    def update_translator_config(self):
        if self.config_store.exists('settings'):
            settings = self.config_store.get('settings')
            self.translator.set_config(
                api_key=settings.get('api_key', ''),
                api_url=settings.get('api_url', 'https://api.siliconflow.cn'),
                model=settings.get('model', 'Qwen/Qwen2.5-7B-Instruct'),
                target_lang=settings.get('target_lang', 'Chinese')
            )
    
    def is_bubble_enabled(self):
        """Check if floating bubble is enabled in settings"""
        if self.config_store.exists('settings'):
            return self.config_store.get('settings').get('enable_bubble', False)
        return False
    
    def on_pause(self):
        """App going to background - keep monitoring"""
        return True
    
    def on_resume(self):
        """App coming back to foreground"""
        print("[App] on_resume called")
        
        # Check if we need to read clipboard (fallback from bubble click when ClipboardBridgeActivity fails)
        if hasattr(self.floating_bubble, 'pending_clipboard_read') and self.floating_bubble.pending_clipboard_read:
            self.floating_bubble.pending_clipboard_read = False
            print("[App] Fallback clipboard read requested")
            Clock.schedule_once(self._read_clipboard_and_translate, 0.3)
    
    def _read_clipboard_and_translate(self, dt):
        """Read clipboard after gaining focus, go back immediately, translate in background"""
        print("[App] Reading clipboard with focus...")
        print(f"[App] Bubble is_showing: {self.floating_bubble.is_showing}")
        
        # Show fallback progress
        self.floating_bubble.update_status("fallback")
        
        clipboard_text = None
        
        # Try Android clipboard API
        if platform == 'android':
            try:
                from jnius import autoclass
                PythonActivity = autoclass('org.kivy.android.PythonActivity')
                Context = autoclass('android.content.Context')
                ClipboardManager = autoclass('android.content.ClipboardManager')
                
                activity = PythonActivity.mActivity
                clipboard = activity.getSystemService(Context.CLIPBOARD_SERVICE)
                
                # Vibrate to indicate reading
                vibrator = activity.getSystemService(Context.VIBRATOR_SERVICE)
                vibrator.vibrate(50)
                
                if clipboard.hasPrimaryClip():
                    clip = clipboard.getPrimaryClip()
                    if clip and clip.getItemCount() > 0:
                        item = clip.getItemAt(0)
                        text = item.coerceToText(activity)
                        if text:
                            clipboard_text = str(text)
                            print(f"[App] Got clipboard: {clipboard_text[:50]}...")
                            # Vibrate longer to indicate success
                            vibrator.vibrate(100)
                        
            except Exception as e:
                print(f"[App] Android clipboard error: {e}")
                import traceback
                traceback.print_exc()
        
        # Fallback to Kivy clipboard
        if not clipboard_text:
            try:
                clipboard_text = Clipboard.paste()
                print(f"[App] Kivy clipboard: {clipboard_text[:50] if clipboard_text else 'empty'}...")
            except Exception as e:
                print(f"[App] Kivy clipboard error: {e}")
        
        if clipboard_text and len(clipboard_text.strip()) > 0:
            # Got text! Go back IMMEDIATELY, then translate in background
            self._go_to_background_now()
            
            # Start background translation (will update bubble when done)
            self.main_widget._do_bubble_translate_with_text(clipboard_text)
        else:
            show_toast("Cannot read clipboard")
            self.floating_bubble.update_status("error")
            # Vibrate to indicate error
            if platform == 'android':
                try:
                    from jnius import autoclass
                    PythonActivity = autoclass('org.kivy.android.PythonActivity')
                    Context = autoclass('android.content.Context')
                    activity = PythonActivity.mActivity
                    vibrator = activity.getSystemService(Context.VIBRATOR_SERVICE)
                    vibrator.vibrate(300)
                except:
                    pass
            # Go back immediately
            self._go_to_background_now()
    
    def _go_to_background(self, dt):
        """Go back to home/previous app (scheduled version)"""
        self._go_to_background_now()
    
    def _go_to_background_now(self):
        """Go back to home/previous app immediately with no animation"""
        print("[App] Going to background immediately...")
        if platform == 'android':
            try:
                from jnius import autoclass
                PythonActivity = autoclass('org.kivy.android.PythonActivity')
                
                activity = PythonActivity.mActivity
                
                # Use moveTaskToBack to go to background
                activity.moveTaskToBack(True)
                
                # Disable transition animation
                try:
                    activity.overridePendingTransition(0, 0)
                except Exception as anim_err:
                    print(f"[App] Could not disable animation: {anim_err}")
                
                print("[App] Moved to background")
            except Exception as e:
                print(f"[App] Go background error: {e}")


if __name__ == '__main__':
    ZoteroTranslatorApp().run()
